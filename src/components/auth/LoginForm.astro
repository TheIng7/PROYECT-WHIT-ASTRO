---
// src/components/auth/LoginForm.astro
---

<div class="login-form">
  <h2>Iniciar Sesión</h2>
  <form id="loginForm" class="auth-form">
    <div class="form-group">
      <label for="email">Email</label>
      <input type="email" id="email" name="email" required class="form-input" />
    </div>
    
    <div class="form-group">
      <label for="password">Contraseña</label>
      <input type="password" id="password" name="password" required class="form-input" />
    </div>

    <button type="submit" class="btn-primary" id="submitBtn">
      Iniciar Sesión
    </button>
  </form>

  <div class="auth-links">
    <p>¿No tienes cuenta? <a href="/auth/register" class="auth-link">Regístrate aquí</a></p>
  </div>
</div>

<style>
  .login-form {
    max-width: 400px;
    margin: 0 auto;
    padding: 2rem;
  }

  h2 {
    color: #1a1a1a;
    text-align: center;
    margin-bottom: 2rem;
    font-size: 1.5rem;
  }

  .form-group {
    margin-bottom: 1.5rem;
  }

  label {
    display: block;
    margin-bottom: 0.5rem;
    color: #374151;
    font-weight: 500;
  }

  .form-input {
    width: 100%;
    padding: 0.75rem;
    border: 2px solid #d1d5db;
    border-radius: 0.5rem;
    font-size: 1rem;
    transition: border-color 0.3s ease;
  }

  .form-input:focus {
    outline: none;
    border-color: #00c853;
  }

  .btn-primary {
    width: 100%;
    background: linear-gradient(135deg, #00c853 0%, #64dd17 100%);
    color: white;
    border: none;
    padding: 0.75rem 1.5rem;
    border-radius: 0.5rem;
    font-size: 1rem;
    font-weight: 600;
    cursor: pointer;
    transition: all 0.3s ease;
    position: relative;
  }

  .btn-primary:disabled {
    opacity: 0.7;
    cursor: not-allowed;
  }

  .btn-primary:hover:not(:disabled) {
    transform: translateY(-2px);
    box-shadow: 0 4px 12px rgba(0, 200, 83, 0.4);
  }

  .loading-spinner {
    width: 20px;
    height: 20px;
    border: 2px solid #ffffff;
    border-top: 2px solid transparent;
    border-radius: 50%;
    animation: spin 1s linear infinite;
    margin: 0 auto;
  }

  @keyframes spin {
    0% { transform: rotate(0deg); }
    100% { transform: rotate(360deg); }
  }

  .auth-links {
    text-align: center;
    margin-top: 1.5rem;
  }

  .auth-link {
    color: #00c853;
    text-decoration: none;
    font-weight: 500;
  }

  .auth-link:hover {
    text-decoration: underline;
  }

  .result-message {
    padding: 1rem;
    border-radius: 0.5rem;
    margin-top: 1rem;
    text-align: center;
  }

  .result-message.success {
    background: #f0fdf4;
    border: 1px solid #bbf7d0;
    color: #166534;
  }

  .result-message.error {
    background: #fef2f2;
    border: 1px solid #fecaca;
    color: #dc2626;
  }
</style>

<script>
  document.addEventListener('DOMContentLoaded', async () => {
    const form = document.getElementById('loginForm');
    const submitBtn = document.getElementById('submitBtn');
    
    form.addEventListener('submit', async (e) => {
      e.preventDefault();
      
      const email = form.email.value;
      const password = form.password.value;
      
      // Validación básica
      if (!email || !password) {
        alert('Por favor completa todos los campos');
        return;
      }
      
      // Mostrar loading
      submitBtn.disabled = true;
      submitBtn.textContent = 'Iniciando sesión...';
      
      try {
        console.log('Cargando Supabase...');
        
        // Cargar Supabase desde CDN
        const { createClient } = await import('https://esm.sh/@supabase/supabase-js@2');
        
        // Usar las variables PUBLIC_ del entorno
        const supabaseUrl = import.meta.env.PUBLIC_SUPABASE_URL;
        const supabaseKey = import.meta.env.PUBLIC_SUPABASE_ANON_KEY;
        
        console.log('URL:', supabaseUrl ? '✅ Disponible' : '❌ No disponible');
        console.log('Key:', supabaseKey ? '✅ Disponible' : '❌ No disponible');
        
        if (!supabaseUrl || !supabaseKey) {
          throw new Error('Configuración de Supabase no encontrada. Verifica las variables PUBLIC_SUPABASE_URL y PUBLIC_SUPABASE_ANON_KEY en tu archivo .env');
        }
        
        const supabase = createClient(supabaseUrl, supabaseKey);
        
        console.log('Intentando login con:', email);
        
        // Llamar a Supabase directamente
        const { data, error } = await supabase.auth.signInWithPassword({
          email,
          password,
        });

        if (error) {
          throw new Error(error.message);
        }

        if (data.user) {
          alert('¡Login exitoso! Redirigiendo al sitio de apuestas...');
          setTimeout(() => {
            window.location.href = '/dashboard';
          }, 1000);
        }
      } catch (error) {
        console.error('Error completo:', error);
        alert('Error: ' + error.message);
      } finally {
        // Restaurar botón
        submitBtn.disabled = false;
        submitBtn.textContent = 'Iniciar Sesión';
      }
    });
  });
</script>

<script>
console.log('SUPABASE_URL:', import.meta.env.PUBLIC_SUPABASE_URL ? '✅' : '❌');
console.log('SUPABASE_KEY:', import.meta.env.PUBLIC_SUPABASE_ANON_KEY ? '✅' : '❌');
</script>